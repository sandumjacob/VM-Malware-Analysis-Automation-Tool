# This Python script runs on the machine that will control the VM enviroments.
# It acts as a server that signals the VMs to execute samples

import externalVMManager, socket, time

IP = '127.0.0.1'
PORT = 5000
BUFFER_SIZE = 2000
SAMPLE_SIGNAL = 'Sample:'

externalVMManager.launchVM()
def sample(samplePath):
    externalVMManager.executeFile(samplePath)
    #TODO: Log stuff here, wait until logging is finished
    enableLogging()
    externalVMManager.cycleVM()

def enableLogging():
    print("Logging Enabled")
    time.sleep(60)

def disableLogging():
    print("Logging Disabled")

clientsocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
clientsocket.connect((IP, PORT))
# Probably change this to while VM ready to sample or something
while True:
    data = clientsocket.recv(BUFFER_SIZE)
    stringData = data.decode()
    if stringData[0:7] == SAMPLE_SIGNAL:
        print("stringData: %s" % (stringData))
        print("Received Path: %s" % stringData[8:len(stringData)])
        sample(stringData[8:len(stringData)])
